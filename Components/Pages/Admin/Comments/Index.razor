@page "/admin/comments"
@layout AdminLayout
@using BlazorBlog.Data
@using Microsoft.EntityFrameworkCore
@inject BlogDbContext DbContext
@rendermode InteractiveServer

<PageTitle>评论管理 - 管理后台</PageTitle>

<div class="admin-page-header">
    <h1 class="admin-page-title">评论管理</h1>
    <p class="admin-page-subtitle">审核和管理用户评论</p>
</div>

@if (isLoading)
{
    <p>正在加载...</p>
}
else
{
    <div class="admin-card">
        <div class="admin-card-header">
            <h3 class="admin-card-title">评论列表 (@comments.Count 条)</h3>
            <div class="d-flex gap-2">
                <select @bind="filterStatus" @bind:after="FilterComments" class="admin-form-input" style="width: 150px;">
                    <option value="">全部状态</option>
                    <option value="published">已发布</option>
                    <option value="pending">待审核</option>
                    <option value="rejected">已拒绝</option>
                </select>
            </div>
        </div>
        <div class="admin-card-body">
            @if (filteredComments.Any())
            {
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>内容</th>
                            <th>作者</th>
                            <th>文章</th>
                            <th>状态</th>
                            <th>点赞数</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var comment in filteredComments)
                        {
                            <tr>
                                <td style="max-width: 300px;">
                                    <div class="text-truncate">@comment.Content</div>
                                    @if (comment.ParentId != null)
                                    {
                                        <small class="text-muted">
                                            <i class="bi bi-reply"></i> 回复评论
                                        </small>
                                    }
                                </td>
                                <td>@comment.User.Username</td>
                                <td style="max-width: 200px;">
                                    <div class="text-truncate">@comment.Post.Title</div>
                                </td>
                                <td>
                                    <span class="status-badge status-@comment.Status">
                                        @(comment.Status == "published" ? "已发布" : comment.Status == "pending" ? "待审核" : "已拒绝")
                                    </span>
                                </td>
                                <td>@comment.LikesCount</td>
                                <td>@comment.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                <td>
                                    <div class="table-actions">
                                        @if (comment.Status == "pending")
                                        {
                                            <button class="btn-action btn-action-primary" @onclick="() => ApproveComment(comment.Id)">
                                                批准
                                            </button>
                                            <button class="btn-action btn-action-danger" @onclick="() => RejectComment(comment.Id)">
                                                拒绝
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn-action btn-action-secondary" @onclick="() => TogglePin(comment)">
                                                @(comment.IsPinned ? "取消置顶" : "置顶")
                                            </button>
                                        }
                                        <button class="btn-action btn-action-danger" @onclick="() => DeleteComment(comment.Id)">
                                            删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-muted text-center py-4">没有找到评论</p>
            }
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private List<Comment> comments = new();
    private List<Comment> filteredComments = new();
    private string filterStatus = string.Empty;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadComments();
    }
    
    private async Task LoadComments()
    {
        try
        {
            comments = await DbContext.Comments
                .Include(c => c.User)
                .Include(c => c.Post)
                .OrderByDescending(c => c.CreatedAt)
                .ToListAsync();
            
            filteredComments = comments;
            isLoading = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading comments: {ex.Message}");
            isLoading = false;
        }
    }
    
    private void FilterComments()
    {
        if (string.IsNullOrWhiteSpace(filterStatus))
        {
            filteredComments = comments;
        }
        else
        {
            filteredComments = comments.Where(c => c.Status == filterStatus).ToList();
        }
    }
    
    private async Task ApproveComment(Guid commentId)
    {
        var comment = await DbContext.Comments.FindAsync(commentId);
        if (comment != null)
        {
            comment.Status = "published";
            await DbContext.SaveChangesAsync();
            await LoadComments();
            FilterComments();
        }
    }
    
    private async Task RejectComment(Guid commentId)
    {
        var comment = await DbContext.Comments.FindAsync(commentId);
        if (comment != null)
        {
            comment.Status = "rejected";
            await DbContext.SaveChangesAsync();
            await LoadComments();
            FilterComments();
        }
    }
    
    private async Task TogglePin(Comment comment)
    {
        comment.IsPinned = !comment.IsPinned;
        await DbContext.SaveChangesAsync();
        StateHasChanged();
    }
    
    private async Task DeleteComment(Guid commentId)
    {
        var comment = await DbContext.Comments.FindAsync(commentId);
        if (comment != null)
        {
            DbContext.Comments.Remove(comment);
            await DbContext.SaveChangesAsync();
            await LoadComments();
            FilterComments();
        }
    }
}
