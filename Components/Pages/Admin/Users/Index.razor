@page "/admin/users"
@layout AdminLayout
@using BlazorBlog.Data
@using Microsoft.EntityFrameworkCore
@inject BlogDbContext DbContext
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>用户管理 - 管理后台</PageTitle>

<div class="admin-page-header">
    <h1 class="admin-page-title">用户管理</h1>
    <p class="admin-page-subtitle">管理所有注册用户</p>
</div>

@if (isLoading)
{
    <p>正在加载...</p>
}
else
{
    <div class="admin-card">
        <div class="admin-card-header">
            <h3 class="admin-card-title">用户列表 (@users.Count 人)</h3>
            <div class="d-flex gap-2">
                <input type="text" @bind="searchTerm" @bind:event="oninput" @onkeyup="SearchUsers" 
                       placeholder="搜索用户..." class="admin-form-input" style="width: 250px;" />
                <button class="btn-action btn-action-primary" @onclick="CreateUser">
                    <i class="bi bi-plus-circle me-1"></i> 新建用户
                </button>
            </div>
        </div>
        <div class="admin-card-body">
            @if (filteredUsers.Any())
            {
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>用户名</th>
                            <th>邮箱</th>
                            <th>角色</th>
                            <th>文章数</th>
                            <th>状态</th>
                            <th>注册时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in filteredUsers)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                        {
                                            <img src="@user.AvatarUrl" alt="@user.Username" 
                                                 style="width: 32px; height: 32px; border-radius: 50%;" />
                                        }
                                        else
                                        {
                                            <div style="width: 32px; height: 32px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center;">
                                                <i class="bi bi-person"></i>
                                            </div>
                                        }
                                        <span>@user.Username</span>
                                    </div>
                                </td>
                                <td>@user.Email</td>
                                <td>
                                    <span class="badge bg-@(user.Role == "admin" ? "danger" : user.Role == "moderator" ? "warning" : "secondary")">
                                        @(user.Role == "admin" ? "管理员" : user.Role == "moderator" ? "版主" : "用户")
                                    </span>
                                </td>
                                <td>@user.PostsCount</td>
                                <td>
                                    <span class="status-badge status-@(user.IsActive ? "active" : "inactive")">
                                        @(user.IsActive ? "激活" : "禁用")
                                    </span>
                                </td>
                                <td>@user.CreatedAt.ToString("yyyy-MM-dd")</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="btn-action btn-action-primary" @onclick="() => EditUser(user.Id)">
                                            编辑
                                        </button>
                                        <button class="btn-action btn-action-secondary" @onclick="() => ToggleUserStatus(user)">
                                            @(user.IsActive ? "禁用" : "激活")
                                        </button>
                                        <button class="btn-action btn-action-danger" @onclick="() => DeleteUser(user.Id)">
                                            删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-muted text-center py-4">没有找到用户</p>
            }
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private List<User> users = new();
    private List<User> filteredUsers = new();
    private string searchTerm = string.Empty;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }
    
    private async Task LoadUsers()
    {
        try
        {
            users = await DbContext.Users
                .OrderByDescending(u => u.CreatedAt)
                .ToListAsync();
            
            filteredUsers = users;
            isLoading = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading users: {ex.Message}");
            isLoading = false;
        }
    }
    
    private void SearchUsers()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredUsers = users;
        }
        else
        {
            filteredUsers = users.Where(u => 
                u.Username.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (u.Nickname != null && u.Nickname.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
            ).ToList();
        }
    }
    
    private void CreateUser()
    {
        // TODO: 实现创建用户功能
        Console.WriteLine("Create user clicked");
    }
    
    private void EditUser(Guid userId)
    {
        Navigation.NavigateTo($"/admin/users/edit/{userId}");
    }
    
    private async Task ToggleUserStatus(User user)
    {
        user.IsActive = !user.IsActive;
        await DbContext.SaveChangesAsync();
        StateHasChanged();
    }
    
    private async Task DeleteUser(Guid userId)
    {
        if (confirm("确定要删除这个用户吗？"))
        {
            var user = await DbContext.Users.FindAsync(userId);
            if (user != null)
            {
                DbContext.Users.Remove(user);
                await DbContext.SaveChangesAsync();
                await LoadUsers();
            }
        }
    }
    
    private bool confirm(string message)
    {
        // 简单的确认，实际应该用更好的UI
        return true;
    }
}
