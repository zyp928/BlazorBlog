@inject UIService UIService
@using BlazorBlog.Services
@using BlazorBlog.Services.Interfaces
@using System.ComponentModel.DataAnnotations
@inject IAuthService AuthService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

@if (isVisible)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-container" @onclick:stopPropagation>
            <button class="btn-close-modal" @onclick="CloseModal">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="modal-header">
                <h3 class="modal-title">登录后继续操作</h3>
                <p class="modal-subtitle">
                    <span class="highlight">CSDN</span> 技术社区
                </p>
            </div>

            <div class="login-tabs">
                <div class="tab-item @(activeTab == "code" ? "active" : "")" @onclick='() => activeTab = "code"'>验证码登录</div>
                <div class="tab-item @(activeTab == "password" ? "active" : "")" @onclick='() => activeTab = "password"'>密码登录</div>
            </div>

            <div class="modal-body">
                @if (activeTab == "code")
                {
                    <!-- 邮箱验证码登录 - 使用 EditForm -->
                    <EditForm Model="emailLoginModel" OnValidSubmit="HandleEmailValidSubmit" OnInvalidSubmit="HandleEmailInvalidSubmit">
                        <DataAnnotationsValidator />
                        
                        <div class="form-group mb-3">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-envelope"></i></span>
                                <InputText class="form-input border-start-0 ps-0" 
                                          @bind-Value="emailLoginModel.Email" 
                                          placeholder="请输入邮箱地址" />
                            </div>
                            <ValidationMessage For="@(() => emailLoginModel.Email)" class="text-danger small mt-1" />
                        </div>
                        
                        <div class="form-group mb-3">
                            <div class="input-group">
                                <InputText class="form-input" 
                                          @bind-Value="emailLoginModel.VerificationCode" 
                                          placeholder="请输入验证码" />
                                <button class="btn-get-code" 
                                        type="button" 
                                        @onclick="SendVerificationCode"
                                        disabled="@(countdown > 0)">
                                    @(countdown > 0 ? $"{countdown}秒后重试" : "获取验证码")
                                </button>
                            </div>
                            <ValidationMessage For="@(() => emailLoginModel.VerificationCode)" class="text-danger small mt-1" />
                        </div>

                        @if (!string.IsNullOrEmpty(emailErrorMessage))
                        {
                            <div class="text-danger small mb-2 text-center">@emailErrorMessage</div>
                        }

                        <button type="submit" class="btn-submit">登录</button>
                    </EditForm>
                }
                else
                {
                    <!-- 密码登录 - 使用 EditForm -->
                    <EditForm Model="loginModel" OnValidSubmit="HandleValidSubmit" OnInvalidSubmit="HandleInvalidSubmit">
                        <DataAnnotationsValidator />
                        
                        <div class="form-group mb-3">
                            <div class="input-group">
                                <InputText class="form-input" 
                                          @bind-Value="loginModel.Username" 
                                          placeholder="请输入账号/邮箱/手机号" />
                            </div>
                            <ValidationMessage For="@(() => loginModel.Username)" class="text-danger small mt-1" />
                        </div>
                        
                        <div class="form-group mb-3">
                            <div class="input-group">
                                <InputText type="password" 
                                          class="form-input" 
                                          @bind-Value="loginModel.Password" 
                                          placeholder="请输入密码" />
                            </div>
                            <ValidationMessage For="@(() => loginModel.Password)" class="text-danger small mt-1" />
                        </div>

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="text-danger small mb-2 text-center">@errorMessage</div>
                        }

                        <button type="submit" class="btn-submit">登录</button>
                    </EditForm>
                }
                
                <div class="agreement">
                    注册登录即表示同意 <a href="#">用户协议</a>、<a href="#">隐私政策</a>
                </div>
            </div>

            <div class="social-login">
                <div class="divider">
                    <span>其他登录方式</span>
                </div>
                <div class="social-icons">
                    <button class="social-btn green">
                        <i class="bi bi-wechat"></i>
                    </button>
                    <button class="social-btn blue">
                        <i class="bi bi-qq"></i>
                    </button>
                    <button class="social-btn black">
                        <i class="bi bi-github"></i>
                    </button>
                    <button class="social-btn red">
                        <i class="bi bi-google"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isVisible = false;
    private string activeTab = "code"; // "code" or "password"
    private string errorMessage = "";
    private string emailErrorMessage = "";
    private LoginModel loginModel = new();
    private EmailLoginModel emailLoginModel = new();
    private int countdown = 0;
    private System.Threading.Timer? countdownTimer;

    // 密码登录模型
    public class LoginModel
    {
        [Required(ErrorMessage = "请输入账号/邮箱/手机号")]
        [StringLength(50, ErrorMessage = "账号长度不能超过50个字符")]
        public string Username { get; set; } = "";

        [Required(ErrorMessage = "请输入密码")]
        [StringLength(100, MinimumLength = 6, ErrorMessage = "密码长度必须在6-100个字符之间")]
        public string Password { get; set; } = "";
    }

    // 邮箱验证码登录模型
    public class EmailLoginModel
    {
        [Required(ErrorMessage = "请输入邮箱地址")]
        [EmailAddress(ErrorMessage = "请输入正确的邮箱地址")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "请输入验证码")]
        [StringLength(6, MinimumLength = 6, ErrorMessage = "验证码为6位数字")]
        [RegularExpression(@"^\d{6}$", ErrorMessage = "验证码必须为6位数字")]
        public string VerificationCode { get; set; } = "";
    }

    protected override void OnInitialized()
    {
        UIService.OnLoginModalRequested += ShowModal;
    }

    private void ShowModal()
    {
        isVisible = true;
        activeTab = "code";
        errorMessage = "";
        emailErrorMessage = "";
        loginModel = new LoginModel(); // 重置密码登录表单
        emailLoginModel = new EmailLoginModel(); // 重置邮箱登录表单
        countdown = 0;
        StateHasChanged();
    }

    private void CloseModal()
    {
        isVisible = false;
        errorMessage = "";
        emailErrorMessage = "";
        loginModel = new LoginModel();
        emailLoginModel = new EmailLoginModel();
        countdown = 0;
        countdownTimer?.Dispose();
        StateHasChanged();
    }

    // 发送验证码
    private async Task SendVerificationCode()
    {
        // 验证邮箱
        if (string.IsNullOrWhiteSpace(emailLoginModel.Email))
        {
            emailErrorMessage = "请输入邮箱地址";
            return;
        }

        if (!new System.ComponentModel.DataAnnotations.EmailAddressAttribute().IsValid(emailLoginModel.Email))
        {
            emailErrorMessage = "请输入正确的邮箱地址";
            return;
        }

        // 检查邮箱是否已注册
        var isRegistered = await AuthService.EmailIsRegisteredAsync(emailLoginModel.Email);
        if (!isRegistered)
        {
            emailErrorMessage = "该邮箱未注册，请先注册账号";
            return;
        }

        // 调用后端发送验证码
        await AuthService.SendEmailVerificationCodeAsync(emailLoginModel.Email);
        
        emailErrorMessage = "验证码已发送（请查看控制台模拟输出）";
        
        // 启动倒计时
        countdown = 60;
        countdownTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                if (countdown > 0)
                {
                    countdown--;
                    StateHasChanged();
                }
                else
                {
                    countdownTimer?.Dispose();
                }
            });
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    // 邮箱验证码登录提交
    private async Task HandleEmailValidSubmit()
    {
        emailErrorMessage = "";
        
        // 1. 调用后端验证验证码
        var isValid = await AuthService.VerifyEmailCodeAsync(emailLoginModel.Email, emailLoginModel.VerificationCode);
        
        if (!isValid)
        {
            emailErrorMessage = "验证码错误或已过期";
            return;
        }

        // 2. 尝试通过邮箱登录
        var user = await AuthService.LoginByEmailAsync(emailLoginModel.Email);
        
        if (user != null)
        {
            var customAuthStateProvider = (CustomAuthenticationStateProvider)AuthStateProvider;
            await customAuthStateProvider.UpdateAuthenticationState(new UserSession
            {
                UserId = user.Id.ToString(),
                Username = user.Username,
                Role = user.Role
            });

            CloseModal();
            StateHasChanged();
        }
        else
        {
            emailErrorMessage = "登录失败，请稍后重试";
        }
    }

    private void HandleEmailInvalidSubmit()
    {
        emailErrorMessage = "";
    }

    // 密码登录提交

    private async Task HandleValidSubmit()
    {
        errorMessage = "";
        
        var user = await AuthService.LoginAsync(loginModel.Username, loginModel.Password);
        if (user != null)
        {
            var customAuthStateProvider = (CustomAuthenticationStateProvider)AuthStateProvider;
            await customAuthStateProvider.UpdateAuthenticationState(new UserSession
            {
                UserId = user.Id.ToString(),
                Username = user.Username,
                Role = user.Role
            });

            CloseModal();
            StateHasChanged();
        }
        else
        {
            errorMessage = "用户名或密码错误";
        }
    }

    private void HandleInvalidSubmit()
    {
        // 表单验证失败时调用
        errorMessage = "";
    }

    public void Dispose()
    {
        UIService.OnLoginModalRequested -= ShowModal;
        countdownTimer?.Dispose();
    }
}
